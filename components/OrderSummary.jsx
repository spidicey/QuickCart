import { useAppContext } from "@/context/AppContext";
import React, { useEffect, useState } from "react";
import Image from "next/image";

const OrderSummary = () => {
  const {
    currency,
    router,
    getCartCount,
    getCartAmount,
    cartData,
    userData,
    apiUrl,
    getCartDetails,
  } = useAppContext();

  const [selectedAddress, setSelectedAddress] = useState(null);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [selectedPayment, setSelectedPayment] = useState("cod");
  const [promoCode, setPromoCode] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);
  const [userAddresses, setUserAddresses] = useState([]);
  const [isLoadingAddresses, setIsLoadingAddresses] = useState(true);

  const paymentMethods = [
    {
      id: "cod",
      name: "Thanh to√°n khi nh·∫≠n h√†ng (COD)",
      icon: "üíµ",
      description: "Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng",
      apiValue: "COD",
    },
    {
      id: "vnpay",
      name: "VNPay",
      icon: "/vnpay-logo.jpg",
      description: "Thanh to√°n qua VNPay",
      apiValue: "VNPAY_QR",
    },
    {
      id: "momo",
      name: "MoMo",
      icon: "/momo-logo.png",
      description: "Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ MoMo",
      apiValue: "MOMO",
    },
    {
      id: "banking",
      name: "Chuy·ªÉn kho·∫£n ng√¢n h√†ng",
      icon: "üè¶",
      description: "Chuy·ªÉn kho·∫£n qua ng√¢n h√†ng",
      apiValue: "BANK_TRANSFER",
    },
  ];

  const fetchUserAddresses = async () => {
    try {
      setIsLoadingAddresses(true);
      const token = localStorage.getItem("access_token");

      if (!token) {
        console.error("No access token found");
        return;
      }

      const response = await fetch(`${apiUrl}/addresses`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
      });

      if (!response.ok) {
        throw new Error("Failed to fetch addresses");
      }

      const data = await response.json();

      // Filter active addresses only
      const activeAddresses = data.filter((addr) => addr.status === true);
      setUserAddresses(activeAddresses);

      // Set default address if available
      const defaultAddress = activeAddresses.find(
        (addr) => addr.is_default === true
      );
      if (defaultAddress) {
        setSelectedAddress(defaultAddress);
      }
    } catch (error) {
      console.error("Error fetching addresses:", error);
      alert("Kh√¥ng th·ªÉ t·∫£i ƒë·ªãa ch·ªâ. Vui l√≤ng th·ª≠ l·∫°i.");
    } finally {
      setIsLoadingAddresses(false);
    }
  };

  const handleAddressSelect = (address) => {
    setSelectedAddress(address);
    setIsDropdownOpen(false);
  };

  const handleApplyPromo = () => {
    // Handle promo code application
    console.log("Applying promo code:", promoCode);
  };

  const createOrder = async () => {
    if (!selectedAddress) {
      alert("Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng");
      return;
    }

    if (!selectedPayment) {
      alert("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n");
      return;
    }

    if (!userData) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng");
      return;
    }

    // Get cart details
    const cartDetails = getCartDetails();

    if (!cartDetails || cartDetails.length === 0) {
      alert("Gi·ªè h√†ng tr·ªëng");
      return;
    }

    setIsProcessing(true);

    try {
      // Prepare order items from cart details
      const items = cartDetails.map((item) => ({
        variantId: item.variantId,
        quantity: item.quantity,
      }));

      // Get selected payment method value
      const paymentMethod = paymentMethods.find(
        (m) => m.id === selectedPayment
      );

      // Prepare order data with the selected address ID
      const orderData = {
        customerId: userData.customer_id || 1,
        addressId: selectedAddress.address_id,
        items: items,
        // paymentMethod: paymentMethod.apiValue,
        // voucherCode: promoCode || null,
        // note: ""
      };

      console.log("Creating order with:", orderData);
      const token = localStorage.getItem("access_token");
      if (!token) return;

      const response = await fetch(`${apiUrl}/orders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(orderData),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.message || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
      }

      console.log("Order created successfully:", result);

      // Handle different payment methods
      if (selectedPayment === "vnpay" && result.qrUrl) {
        // Redirect to VNPay payment page
        window.location.href = result.qrUrl;
      } else if (selectedPayment === "momo" && result.payUrl) {
        // Redirect to MoMo payment page
        window.location.href = result.payUrl;
      } else {
        alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
        router.push(`/order-success/${result.order.order_id}`);
      }
    } catch (error) {
      console.error("Error creating order:", error);
      alert(error.message || "C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
    } finally {
      setIsProcessing(false);
    }
  };

  useEffect(() => {
    fetchUserAddresses();
  }, []);

  return (
    <div className="w-full md:w-96 bg-gray-500/5 p-5">
      <h2 className="text-xl md:text-2xl font-medium text-gray-700">
        T√≥m T·∫Øt ƒê∆°n H√†ng
      </h2>
      <hr className="border-gray-500/30 my-5" />
      <div className="space-y-6">
        {/* Address Selection */}
        <div>
          <label className="text-base font-medium uppercase text-gray-600 block mb-2">
            Ch·ªçn ƒê·ªãa Ch·ªâ
          </label>
          <div className="relative inline-block w-full text-sm border">
            <button
              className="peer w-full text-left px-4 pr-2 py-2 bg-white text-gray-700 focus:outline-none"
              onClick={() => setIsDropdownOpen(!isDropdownOpen)}
              disabled={isLoadingAddresses}
            >
              <span>
                {isLoadingAddresses
                  ? "ƒêang t·∫£i ƒë·ªãa ch·ªâ..."
                  : selectedAddress
                  ? `${selectedAddress.consignee_name}, ${selectedAddress.house_num} ${selectedAddress.street}, ${selectedAddress.ward}, ${selectedAddress.district}, ${selectedAddress.province}`
                  : "Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng"}
              </span>
              <svg
                className={`w-5 h-5 inline float-right transition-transform duration-200 ${
                  isDropdownOpen ? "rotate-0" : "-rotate-90"
                }`}
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="#6B7280"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            {isDropdownOpen && (
              <ul className="absolute w-full bg-white border shadow-md mt-1 z-10 py-1.5 max-h-64 overflow-y-auto">
                {userAddresses.length === 0 ? (
                  <li className="px-4 py-2 text-gray-500 text-center">
                    Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o
                  </li>
                ) : (
                  userAddresses.map((address) => (
                    <li
                      key={address.address_id}
                      className="px-4 py-2 hover:bg-gray-500/10 cursor-pointer"
                      onClick={() => handleAddressSelect(address)}
                    >
                      <div>
                        <p className="font-medium">{address.consignee_name}</p>
                        <p className="text-xs text-gray-600">
                          {address.house_num} {address.street}, {address.ward},{" "}
                          {address.district}, {address.province}
                        </p>
                        <p className="text-xs text-gray-500">
                          {address.consignee_phone}
                        </p>
                        {address.is_default && (
                          <span className="text-xs text-orange-600 font-medium">
                            (M·∫∑c ƒë·ªãnh)
                          </span>
                        )}
                      </div>
                    </li>
                  ))
                )}
                <li
                  onClick={() => router.push("/add-address")}
                  className="px-4 py-2 hover:bg-gray-500/10 cursor-pointer text-center border-t mt-1 pt-2 text-orange-600 font-medium"
                >
                  + Th√™m ƒê·ªãa Ch·ªâ M·ªõi
                </li>
              </ul>
            )}
          </div>
        </div>

        {/* Payment Method Selection */}
        <div>
          <label className="text-base font-medium uppercase text-gray-600 block mb-3">
            Ph∆∞∆°ng Th·ª©c Thanh To√°n
          </label>
          <div className="space-y-2">
            {paymentMethods.map((method) => (
              <div
                key={method.id}
                onClick={() => setSelectedPayment(method.id)}
                className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition ${
                  selectedPayment === method.id
                    ? "border-orange-500 bg-orange-50"
                    : "border-gray-300 hover:border-gray-400 bg-white"
                }`}
              >
                <input
                  type="radio"
                  name="payment"
                  checked={selectedPayment === method.id}
                  onChange={() => setSelectedPayment(method.id)}
                  className="w-4 h-4 text-orange-600 cursor-pointer"
                />
                <div className="flex items-center gap-2 flex-1">
                  {method.icon.startsWith("/") ? (
                    <div className="w-8 h-8 flex items-center justify-center">
                      <img
                        src={method.icon}
                        alt={method.name}
                        className="max-w-full max-h-full object-contain"
                        onError={(e) => {
                          e.target.style.display = "none";
                          e.target.nextElementSibling.style.display = "block";
                        }}
                      />
                      <span className="text-2xl hidden">
                        {method.id === "vnpay" ? "üí≥" : "üì±"}
                      </span>
                    </div>
                  ) : (
                    <span className="text-2xl">{method.icon}</span>
                  )}
                  <div className="flex-1">
                    <p
                      className={`font-medium text-sm ${
                        selectedPayment === method.id
                          ? "text-orange-600"
                          : "text-gray-800"
                      }`}
                    >
                      {method.name}
                    </p>
                    <p className="text-xs text-gray-500">
                      {method.description}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Promo Code */}
        <div>
          <label className="text-base font-medium uppercase text-gray-600 block mb-2">
            M√£ Gi·∫£m Gi√°
          </label>
          <div className="flex items-center gap-2">
            <input
              type="text"
              placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"
              value={promoCode}
              onChange={(e) => setPromoCode(e.target.value)}
              className="flex-grow w-full outline-none p-2.5 text-gray-600 border rounded"
            />
            <button
              onClick={handleApplyPromo}
              className="bg-orange-600 text-white px-6 py-2.5 hover:bg-orange-700 rounded whitespace-nowrap"
            >
              √Åp D·ª•ng
            </button>
          </div>
        </div>

        <hr className="border-gray-500/30 my-5" />

        {/* Order Summary */}
        <div className="space-y-4">
          <div className="flex justify-between text-base font-medium">
            <p className="uppercase text-gray-600">
              S·∫£n Ph·∫©m ({getCartCount()})
            </p>
            <p className="text-gray-800">
              {currency}
              {getCartAmount().toLocaleString()}
            </p>
          </div>
          <div className="flex justify-between">
            <p className="text-gray-600">Ph√≠ V·∫≠n Chuy·ªÉn</p>
            <p className="font-medium text-gray-800">Mi·ªÖn Ph√≠</p>
          </div>
          <div className="flex justify-between">
            <p className="text-gray-600">Thu·∫ø (2%)</p>
            <p className="font-medium text-gray-800">
              {currency}
              {Math.floor(getCartAmount() * 0.02).toLocaleString()}
            </p>
          </div>
          <div className="flex justify-between text-lg md:text-xl font-medium border-t pt-3">
            <p>T·ªïng C·ªông</p>
            <p>
              {currency}
              {(
                getCartAmount() + Math.floor(getCartAmount() * 0.02)
              ).toLocaleString()}
            </p>
          </div>
        </div>
      </div>

      <button
        onClick={createOrder}
        disabled={isProcessing}
        className={`w-full bg-orange-600 text-white py-3 mt-5 hover:bg-orange-700 rounded transition ${
          isProcessing ? "opacity-50 cursor-not-allowed" : ""
        }`}
      >
        {isProcessing ? "ƒêang x·ª≠ l√Ω..." : "ƒê·∫∑t H√†ng"}
      </button>

      <p className="text-xs text-gray-500 text-center mt-3">
        B·∫±ng c√°ch ƒë·∫∑t h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi{" "}
        <span className="text-orange-600 cursor-pointer hover:underline">
          ƒêi·ªÅu kho·∫£n & ƒêi·ªÅu ki·ªán
        </span>
      </p>
    </div>
  );
};

export default OrderSummary;
